import streamlit as st
import pandas as pd

st.set_page_config(page_title="競馬アプリ（安定版）", layout="wide")

# ---------------------------------------------------
# デモ用出馬表（本番仕様 column structure）
# ---------------------------------------------------
horses = [
    {
        "枠": 1,
        "馬番": 1,
        "馬名": "サンプルホースA",
        "性齢": "牡4",
        "斤量": 55.0,
        "騎手": "川田",
        "調教師": "中内田",
        "馬主": "サンプルオーナー",
        "生産者": "ノーザンF",
        "父": "サンプルサイヤー",
        "母": "サンプルマザー",
        "母父": "ディープ系",
        "前走": "天皇賞秋 5着",
        "オッズ": 3.8,
        "人気": 1,
    },
    {
        "枠": 2,
        "馬番": 2,
        "馬名": "サンプルホースB",
        "性齢": "牝3",
        "斤量": 53.0,
        "騎手": "ルメール",
        "調教師": "国枝",
        "馬主": "シルク",
        "生産者": "ノーザンF",
        "父": "ロードカナロア",
        "母": "サンプルマザーB",
        "母父": "キングカメハメハ",
        "前走": "オークス 2着",
        "オッズ": 5.5,
        "人気": 2,
    },
    {
        "枠": 3,
        "馬番": 3,
        "馬名": "サンプルホースC",
        "性齢": "牡5",
        "斤量": 57.0,
        "騎手": "武豊",
        "調教師": "友道",
        "馬主": "サンデーR",
        "生産者": "社台F",
        "父": "ハーツクライ",
        "母": "サンプルマザーC",
        "母父": "サンデー系",
        "前走": "札幌記念 3着",
        "オッズ": 8.7,
        "人気": 3,
    },
]

df = pd.DataFrame(horses)

# ---------------------------------------------------
# 印リスト
# ---------------------------------------------------
MARK_LIST = ["", "◎", "○", "▲", "△", "×", "⭐︎"]

# セッションステートの初期化
if "marks" not in st.session_state:
    st.session_state.marks = [""] * len(df)

# ---------------------------------------------------
# タブ構成
# ---------------------------------------------------
tab_shutuba, tab_score, tab_ai, tab_baken, tab_info = st.tabs(
    ["出馬表", "スコア", "AIスコア", "馬券", "基本情報"]
)

# ---------------------------------------------------
# 出馬表タブ（本番仕様・完全版）
# ---------------------------------------------------
with tab_shutuba:
    st.subheader("出馬表（本番仕様）")

    # 印選択
    st.write("### 印の選択")
    new_marks = []
    for i, row in df.iterrows():
        key = f"mark_select_{i}"
        selected = st.selectbox(
            f"{row['馬名']} の印",
            MARK_LIST,
            index=MARK_LIST.index(st.session_state.marks[i]),
            key=key
        )
        new_marks.append(selected)

    # 印を更新
    st.session_state.marks = new_marks
    df_display = df.copy()
    df_display["印"] = st.session_state.marks

    # 出馬表の表示（枠・馬番固定）
    st.write("### 印付き出馬表")
    st.dataframe(
        df_display,
        width="stretch",
        hide_index=True
    )
